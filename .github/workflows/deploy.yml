name: Deploy to Timeweb

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BOT: grigra27/fair_sber_price-bot

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd fsp
        pip install -r requirements.txt
        pip install -r requirements-prod.txt
    
    - name: Run Django checks
      run: |
        cd fsp
        python manage.py check
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
        ALLOWED_HOSTS: localhost
        TELEGRAM_BOT_TOKEN: test-token

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata for bot image
      id: meta-bot
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BOT }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push bot image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.bot
        push: true
        tags: ${{ steps.meta-bot.outputs.tags }}
        labels: ${{ steps.meta-bot.outputs.labels }}
    
    - name: Output bot image digest
      run: echo "Bot image pushed with tags - ${{ steps.meta-bot.outputs.tags }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Deploy bot to Timeweb
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TW_HOST }}
        username: ${{ secrets.TW_USERNAME }}
        key: ${{ secrets.TW_SSH_KEY }}
        script: |
          set -e
          echo "ðŸš€ Starting deployment..."

          # Create application directory
          mkdir -p /opt/fair-sber-price
          cd /opt/fair-sber-price

          # Create runtime directories
          mkdir -p fsp/logs fsp/staticfiles fsp/db

          # Recreate environment file (handles stale permissions/ownership)
          rm -rf .env
          cat > .env << EOF
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          BOT_ONLY_MODE=True
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          EOF
          chmod 600 .env

          # Copy docker-compose config from repository
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o docker-compose.prod.yml \
               -L https://api.github.com/repos/${{ github.repository }}/contents/docker-compose.prod.yml?ref=${{ github.sha }}

          # Login to GitHub Container Registry
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Pull and restart bot service
          echo "ðŸ“¥ Pulling latest Docker images..."
          docker-compose -f docker-compose.prod.yml pull telegram-bot
          docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans telegram-bot

          # Show status
          echo "ðŸ“¦ Running containers:"
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"

          echo "ðŸ“Š Checking deployment status..."
          docker-compose -f docker-compose.prod.yml ps

          docker image prune -f

          echo "ðŸŽ‰ Deployment completed!"
