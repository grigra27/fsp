#!/bin/bash

echo "üåê –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º..."
echo "================================="

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ
SERVER_IP=$(hostname -I | awk '{print $1}')
DOMAIN="fsp.hopto.org"

echo "üñ•Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "IP –∞–¥—Ä–µ—Å: $SERVER_IP"
echo "–î–æ–º–µ–Ω: $DOMAIN"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–µ–∑–æ–ª—é—Ü–∏–∏:"
nslookup $DOMAIN || echo "‚ùå DNS —Ä–µ–∑–æ–ª—é—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
dig $DOMAIN A +short || echo "‚ùå dig –∫–æ–º–∞–Ω–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:"
echo "–ü–æ—Ä—Ç 8000 (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ):"
netstat -tlnp | grep :8000 || ss -tlnp | grep :8000 || echo "‚ùå –ü–æ—Ä—Ç 8000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"

echo "–ü–æ—Ä—Ç 80 (HTTP):"
netstat -tlnp | grep :80 || ss -tlnp | grep :80 || echo "‚ÑπÔ∏è –ü–æ—Ä—Ç 80 –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è"

echo "–ü–æ—Ä—Ç 443 (HTTPS):"
netstat -tlnp | grep :443 || ss -tlnp | grep :443 || echo "‚ÑπÔ∏è –ü–æ—Ä—Ç 443 –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è"

echo ""
echo "üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ (UFW):"
if command -v ufw &> /dev/null; then
    ufw status
else
    echo "‚ÑπÔ∏è UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

echo ""
echo "üî• –ü—Ä–æ–≤–µ—Ä–∫–∞ iptables:"
iptables -L INPUT -n | grep -E "(8000|80|443)" || echo "‚ÑπÔ∏è –ù–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –¥–ª—è –≤–µ–±-–ø–æ—Ä—Ç–æ–≤"

echo ""
echo "üîç –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:"
echo "1. –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç:"
curl -I http://localhost:8000/ 2>/dev/null && echo "‚úÖ Localhost —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Localhost –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"

echo "2. –¢–µ—Å—Ç –ø–æ IP:"
curl -I http://$SERVER_IP:8000/ 2>/dev/null && echo "‚úÖ IP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå IP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"

echo "3. –¢–µ—Å—Ç –ø–æ –¥–æ–º–µ–Ω—É (–µ—Å–ª–∏ DNS —Ä–∞–±–æ—Ç–∞–µ—Ç):"
if nslookup $DOMAIN > /dev/null 2>&1; then
    curl -I http://$DOMAIN:8000/ 2>/dev/null && echo "‚úÖ –î–æ–º–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå –î–æ–º–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –¥–æ–º–µ–Ω–∞ (DNS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)"
fi

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ALLOWED_HOSTS –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:"
cd /opt/fair-sber-price
if [ -f .env ]; then
    echo "ALLOWED_HOSTS –∏–∑ .env:"
    grep ALLOWED_HOSTS .env || echo "‚ùå ALLOWED_HOSTS –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env"
else
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
docker-compose -f docker-compose.prod.yml ps web

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ nginx (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):"
docker logs fsp_nginx --tail=10 2>/dev/null || echo "‚ÑπÔ∏è Nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"

echo ""
echo "================================="
echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "1. –ï—Å–ª–∏ localhost —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ IP/–¥–æ–º–µ–Ω –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π—Ä–≤–æ–ª–æ–º"
echo "2. –ï—Å–ª–∏ DNS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –æ–±–Ω–æ–≤–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞"
echo "3. –ï—Å–ª–∏ –ø–æ—Ä—Ç 8000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è - –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ALLOWED_HOSTS –≤ .env —Ñ–∞–π–ª–µ"