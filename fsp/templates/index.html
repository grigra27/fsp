{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Error Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-12">
            <h5>–ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ü–∏–π {% include "includes/bank_name.txt" %}</h5>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">–∑–∞–≥—Ä—É–∑–∫–∞...</span></small>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                        <span id="refresh-icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <form method="post" action="{% url 'price:save_snapshot' %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–Ω–∏–º–æ–∫</button>
                    </form>
                </div>
            </div>
            <br>
        </div>
    </div>
    
    <div class="row">
        <div class="col-4">
            <br><br>
            <p>–°–æ–≥–ª–∞—Å–Ω–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—É P/B<br>–∞–∫—Ü–∏–∏ –æ—Ü–µ–Ω–µ–Ω—ã</p>
            <h2 id="price-score" class="price-score-{{ price_score|slugify }}">{{ price_score }}</h2>
            <div class="mt-3">
                <small class="text-muted">P/B –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <span id="pb-ratio">{{ pb_ratio|default:"–∑–∞–≥—Ä—É–∑–∫–∞..." }}</span></small>
            </div>
        </div>
        
        <div class="col-7">
            <div id="loading-spinner" class="text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p class="mt-2">–ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...</p>
            </div>
            
            <div id="price-content">
                <p>
                    <h1 class="display-4">
                        <b><span id="fair-price">{{ fair_price }}</span> —Ä—É–±–ª–µ–π</b>
                    </h1>
                    —Ç–∞–∫–æ–≤–∞ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –æ–¥–Ω–æ–π –∞–∫—Ü–∏–∏ <mark>{% include "includes/bank_name.txt" %}</mark> –∏—Å—Ö–æ–¥—è –∏–∑ 
                    –æ—Ü–µ–Ω–∫–∏ –±–∞–Ω–∫–∞ –≤ 1 –∫–∞–ø–∏—Ç–∞–ª (–º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä P/B = 1)
                    <br>
                    <small class="text-body-secondary">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#explanationModal">–ü–æ—á–µ–º—É 1 –∫–∞–ø–∏—Ç–∞–ª?</a>
                    </small>
                </p>
                <br>
                
                <p>
                    –ü—Ä–∏ —ç—Ç–æ–º –Ω–∞ —Ä—ã–Ω–∫–µ –∞–∫—Ü–∏–∏ —Å—Ç–æ—è—Ç: 
                    <span class="h3" id="moex-price">{{ moex_price }}</span> —Ä—É–±–ª–µ–π<br>
                    <small>—Ç–∞–∫–æ–≤–∞ —Ü–µ–Ω–∞ –æ–¥–Ω–æ–π –∞–∫—Ü–∏–∏ <mark>{% include "includes/bank_name.txt" %}</mark> –Ω–∞ –ú–æ—Å–±–∏—Ä–∂–µ</small>
                </p>
                <br><br>
                
                <p>
                    <span>NB:</span>
                    –î–∏–∞–ø–∞–∑–æ–Ω 1 - 1,2 –∫–∞–ø–∏—Ç–∞–ª–∞ —Ä–∞–≤–µ–Ω –æ—Ü–µ–Ω–∫–µ –∞–∫—Ü–∏–∏ 
                    <b><span id="fair-price-range">{{ fair_price }} - {{ fair_price_20_percent }}</span> —Ä—É–±–ª–µ–π</b><br>
                    <small class="text-body-secondary">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#rangeModal">–ü–æ—á–µ–º—É –º—ã –≤—ã–±–∏—Ä–∞–µ–º —Ç–∞–∫–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω?</a>
                    </small>
                </p>
            </div>
        </div>
        <div class="col-1"></div>
    </div>
</div>

<!-- Explanation Modal -->
<div class="modal fade" id="explanationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ—á–µ–º—É 1 –∫–∞–ø–∏—Ç–∞–ª?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä P/B (Price-to-Book) = 1 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ä—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∞–Ω–∫–∞ —Ä–∞–≤–Ω–∞ –µ–≥–æ –±–∞–ª–∞–Ω—Å–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∫–∞–ø–∏—Ç–∞–ª—É).</p>
                <p>–î–ª—è –±–∞–Ω–∫–æ–≤ —ç—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π –æ—Ü–µ–Ω–∫–æ–π, –ø–æ—Å–∫–æ–ª—å–∫—É:</p>
                <ul>
                    <li>–ê–∫—Ç–∏–≤—ã –±–∞–Ω–∫–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∏ –±–ª–∏–∑–∫–∏ –∫ —Ä—ã–Ω–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏</li>
                    <li>P/B = 1 –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ —è–≤–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞</li>
                    <li>–ü—Ä–∏ P/B < 1 –∞–∫—Ü–∏–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–º–∏</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Range Modal -->
<div class="modal fade" id="rangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–∏–∞–ø–∞–∑–æ–Ω 1-1.2 –∫–∞–ø–∏—Ç–∞–ª–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–î–∏–∞–ø–∞–∑–æ–Ω P/B –æ—Ç 1.0 –¥–æ 1.2 —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–æ–Ω–æ–π —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π –æ—Ü–µ–Ω–∫–∏ –¥–ª—è –±–∞–Ω–∫–æ–≤:</p>
                <ul>
                    <li><strong>P/B = 1.0</strong> - –±–∞–∑–æ–≤–∞—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</li>
                    <li><strong>P/B = 1.2</strong> - –ø—Ä–µ–º–∏—è –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–æ—Å—Ç–∞</li>
                    <li>–í—ã—à–µ 1.2 - –∞–∫—Ü–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Ä–æ–≥–∏–º–∏</li>
                    <li>–ù–∏–∂–µ 1.0 - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–µ</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.price-score-–¥–µ—à–µ–≤–æ { color: #28a745; }
.price-score-—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ { color: #007bff; }
.price-score-—á—É—Ç—å-–¥–æ—Ä–æ–≥–æ { color: #fd7e14; }
.price-score-–¥–æ—Ä–æ–≥–æ { color: #dc3545; }
.price-score-–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ { color: #6c757d; }
</style>

<script>
async function refreshData() {
    const refreshIcon = document.getElementById('refresh-icon');
    const loadingSpinner = document.getElementById('loading-spinner');
    const priceContent = document.getElementById('price-content');
    
    // Show loading state
    refreshIcon.textContent = '‚è≥';
    loadingSpinner.style.display = 'block';
    priceContent.style.opacity = '0.5';
    
    try {
        const response = await fetch('{% url "price:api_current_data" %}');
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            
            // Update DOM elements
            document.getElementById('moex-price').textContent = data.moex_price || '–ù/–î';
            document.getElementById('fair-price').textContent = data.fair_price || '–ù/–î';
            document.getElementById('fair-price-range').textContent = 
                `${data.fair_price || '–ù/–î'} - ${data.fair_price_20_percent || '–ù/–î'}`;
            document.getElementById('price-score').textContent = data.price_score || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            document.getElementById('pb-ratio').textContent = data.pb_ratio || '–ù/–î';
            document.getElementById('last-update').textContent = 
                new Date(data.timestamp).toLocaleString('ru-RU');
            
            // Update price score color
            const scoreElement = document.getElementById('price-score');
            scoreElement.className = `price-score-${data.price_score.replace(/\s+/g, '-')}`;
            
        } else {
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
    } catch (error) {
        console.error('Error refreshing data:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    } finally {
        // Hide loading state
        refreshIcon.textContent = 'üîÑ';
        loadingSpinner.style.display = 'none';
        priceContent.style.opacity = '1';
    }
}

// Auto-refresh every 5 minutes
setInterval(refreshData, 5 * 60 * 1000);

// Set initial last update time
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('last-update').textContent = new Date().toLocaleString('ru-RU');
});
</script>
{% endblock %}
